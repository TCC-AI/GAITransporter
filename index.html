/**
 * 記錄操作日誌
 */
function logOperation(action, params, result) {
  try {
    let sheet = getSheet(SHEET_CONFIG.SHEETS.LOGS);
    if (!sheet) {
      const spreadsheet = SpreadsheetApp.openById(SHEET_CONFIG.SHEET_ID);
      sheet = spreadsheet.insertSheet(SHEET_CONFIG.SHEETS.LOGS);
      
      const headers = [
        '時間戳記', '操作', '參數', '結果', '成功', '錯誤訊息', '操作人員'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
    }
    
    const newRow = [
      new Date(),
      action,
      JSON.stringify(params),
      JSON.stringify(result),
      result.success,
      result.error || '',
      Session.getActiveUser().getEmail()
    ];
    
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, 1, newRow.length).setValues([newRow]);
    
    return true;
    
  } catch (error) {
    Logger.log('Error in logOperation: ' + error.toString());
    return false;
  }
}

/**
 * 解析時間窗
 */
function parseTimeWindow(dateValue, remarks) {
  try {
    let startTime = '09:00';
    let endTime = '17:00';
    
    if (remarks) {
      // 從備註中解析時間窗
      const timePattern = /(\d{1,2}):(\d{2})\s*[-~到至]\s*(\d{1,2}):(\d{2})/;
      const match = remarks.match(timePattern);
      
      if (match) {
        startTime = `${match[1].padStart(2, '0')}:${match[2]}`;
        endTime = `${match[3].padStart(2, '0')}:${match[4]}`;
      }
    }
    
    return { startTime, endTime };
    
  } catch (error) {
    Logger.log('Error in parseTimeWindow: ' + error.toString());
    return { startTime: '09:00', endTime: '17:00' };
  }
}

/**
 * 取得工作表參考
 */
function getSheet(sheetName) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SHEET_CONFIG.SHEET_ID);
    return spreadsheet.getSheetByName(sheetName);
  } catch (error) {
    Logger.log(`Error getting sheet ${sheetName}: ${error.toString()}`);
    return null;
  }
}

/**
 * 包含 HTML 檔案的函數
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}


🌐 前端 HTML 檔案 (index.html) - 真實版本
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAI優化運務人員調派建議系統</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* KPI 儀表板樣式 */
        .kpi-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .kpi-change {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .kpi-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .kpi-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        /* 主要內容區域 */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* 篩選器樣式 */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* 按鈕樣式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 表格樣式 */
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.85rem;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-assigned {
            background: #d4edda;
            color: #155724;
        }

        .status-in-progress {
            background: #cce5ff;
            color: #004085;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .level-p {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        .level-q {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .level-r {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        /* 操作按鈕 */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        /* 建議卡片樣式 */
        .suggestions-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .suggestion-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .suggestion-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .suggestion-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .suggestion-score {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .suggestion-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }

        .suggestion-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        /* 載入動畫 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 通知樣式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .kpi-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }

        /* 全螢幕載入遮罩 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* 操作面板 */
        .action-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .action-buttons-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .last-updated {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 標題區域 -->
        <div class="header">
            <h1><i class="fas fa-truck"></i> GAI優化運務人員調派建議系統</h1>
            <p>基於 Google Sheets 的智能配送調度管理平台</p>
        </div>

        <!-- KPI 儀表板 -->
        <div class="kpi-dashboard" id="kpiDashboard">
            <!-- KPI 卡片將由 JavaScript 動態生成 -->
        </div>

        <!-- 操作面板 -->
        <div class="action-panel">
            <div class="action-buttons-row">
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> 重新整理
                </button>
                <button class="btn btn-success" onclick="autoAssignAll()">
                    <i class="fas fa-magic"></i> 自動配對全部
                </button>
                <button class="btn btn-warning" onclick="publishToApp()">
                    <i class="fas fa-paper-plane"></i> 發佈到APP
                </button>
                <button class="btn btn-secondary" onclick="exportResults()">
                    <i class="fas fa-download"></i> 匯出結果
                </button>
            </div>
        </div>

        <!-- 主要內容區域 -->
        <div class="main-content">
            <!-- 待派任務區域 -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-tasks"></i> 待派任務管理
                </h2>
                
                <!-- 任務篩選器 -->
                <div class="filters">
                    <div class="filter-group">
                        <label>日期</label>
                        <input type="date" id="taskDateFilter" onchange="filterTasks()">
                    </div>
                    <div class="filter-group">
                        <label>狀態</label>
                        <select id="taskStatusFilter" onchange="filterTasks()">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>客戶等級</label>
                        <select id="taskLevelFilter" onchange="filterTasks()">
                            <option value="">全部</option>
                            <option value="P">P級 (優先)</option>
                            <option value="Q">Q級 (一般)</option>
                            <option value="R">R級 (彈性)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>客戶</label>
                        <select id="taskCustomerFilter" onchange="filterTasks()">
                            <option value="">全部客戶</option>
                        </select>
                    </div>
                </div>

                <!-- 任務表格 -->
                <div class="table-container">
                    <table id="tasksTable">
                        <thead>
                            <tr>
                                <th>配送單號</th>
                                <th>客戶</th>
                                <th>等級</th>
                                <th>狀態</th>
                                <th>配送時間</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            <!-- 資料將由 JavaScript 動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 配對建議區域 -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-lightbulb"></i> AI 配對建議
                </h2>
                
                <div id="selectedTaskInfo" style="display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>選中任務：<span id="selectedTaskId"></span></h4>
                        <p>客戶：<span id="selectedTaskCustomer"></span></p>
                        <p>等級：<span id="selectedTaskLevel"></span></p>
                        <p>配送時間：<span id="selectedTaskTime"></span></p>
                    </div>
                </div>

                <div id="suggestionsContainer" class="suggestions-container">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <i class="fas fa-hand-pointer" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>請選擇一個待派任務以查看 AI 配對建議</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 資源管理區域 -->
        <div class="main-content">
            <!-- 司機管理 -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-users"></i> 司機資源管理
                </h2>
                
                <!-- 司機篩選器 -->
                <div class="filters">
                    <div class="filter-group">
                        <label>等級</label>
                        <select id="driverLevelFilter" onchange="filterDrivers()">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>狀態</label>
                        <select id="driverStatusFilter" onchange="filterDrivers()">
                            <option value="">全部</option>
                        </select>
                    </div>
                </div>

                <!-- 司機表格 -->
                <div class="table-container">
                    <table id="driversTable">
                        <thead>
                            <tr>
                                <th>編號</th>
                                <th>姓名</th>
                                <th>等級</th>
                                <th>狀態</th>
                                <th>今日工時</th>
                                <th>準點率</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="driversTableBody">
                            <!-- 資料將由 JavaScript 動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 車輛管理 -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-truck"></i> 車輛資源管理
                </h2>
                
                <!-- 車輛篩選器 -->
                <div class="filters">
                    <div class="filter-group">
                        <label>類型</label>
                        <select id="vehicleTypeFilter" onchange="filterVehicles()">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>狀態</label>
                        <select id="vehicleStatusFilter" onchange="filterVehicles()">
                            <option value="">全部</option>
                        </select>
                    </div>
                </div>

                <!-- 車輛表格 -->
                <div class="table-container">
                    <table id="vehiclesTable">
                        <thead>
                            <tr>
                                <th>車牌</th>
                                <th>類型</th>
                                <th>容量</th>
                                <th>狀態</th>
                                <th>今日使用</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="vehiclesTableBody">
                            <!-- 資料將由 JavaScript 動態載入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 最後更新時間 -->
        <div class="last-updated" id="lastUpdated">
            最後更新：載入中...
        </div>
    </div>

    <!-- JavaScript 程式碼 -->
    <script>
        // 全域變數
        let currentTasks = [];
        let currentDrivers = [];
        let currentVehicles = [];
        let dropdownData = {};
        let selectedTaskId = null;

        // Web App URL - 請替換為您的實際 URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz3EjwUQqpR9PzYN6iB04rwfCtYYNr8MlNLp_WM6MngmQF_nQOWxQGOgHl1pwn2szilRA/exec';

        /**
         * 頁面載入完成後初始化
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('頁面載入完成，開始初始化...');
            initializeApp();
        });

        /**
         * 初始化應用程式
         */
        async function initializeApp() {
            try {
                showLoadingOverlay(true);
                
                // 載入下拉選單資料
                await loadDropdownData();
                
                // 載入所有資料
                await Promise.all([
                    loadKPIData(),
                    loadTasks(),
                    loadDrivers(),
                    loadVehicles()
                ]);
                
                // 設定今日日期為預設篩選
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('taskDateFilter').value = today;
                
                showNotification('系統初始化完成', 'success');
                updateLastUpdatedTime();
                
            } catch (error) {
                console.error('初始化失敗:', error);
                showNotification('系統初始化失敗: ' + error.message, 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        /**
         * 載入下拉選單資料
         */
        async function loadDropdownData() {
            try {
                const response = await callGoogleAppsScript('getDropdownData');
                if (response.success) {
                    dropdownData = response.data;
                    populateDropdowns();
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('載入下拉選單資料失敗:', error);
                throw error;
            }
        }

        /**
         * 填充下拉選單
         */
        function populateDropdowns() {
            // 任務狀態
            const taskStatusFilter = document.getElementById('taskStatusFilter');
            taskStatusFilter.innerHTML = '<option value="">全部</option>';
            dropdownData.taskStatuses.forEach(status => {
                taskStatusFilter.innerHTML += `<option value="${status}">${status}</option>`;
            });

            // 客戶列表
            const taskCustomerFilter = document.getElementById('taskCustomerFilter');
            taskCustomerFilter.innerHTML = '<option value="">全部客戶</option>';
            dropdownData.customers.forEach(customer => {
                taskCustomerFilter.innerHTML += `<option value="${customer}">${customer}</option>`;
            });

            // 司機等級
            const driverLevelFilter = document.getElementById('driverLevelFilter');
            driverLevelFilter.innerHTML = '<option value="">全部</option>';
            dropdownData.driverLevels.forEach(level => {
                driverLevelFilter.innerHTML += `<option value="${level}">${level}級</option>`;
            });

            // 司機狀態
            const driverStatusFilter = document.getElementById('driverStatusFilter');
            driverStatusFilter.innerHTML = '<option value="">全部</option>';
            dropdownData.driverStatuses.forEach(status => {
                driverStatusFilter.innerHTML += `<option value="${status}">${status}</option>`;
            });

            // 車輛類型
            const vehicleTypeFilter = document.getElementById('vehicleTypeFilter');
            vehicleTypeFilter.innerHTML = '<option value="">全部</option>';
            dropdownData.vehicleTypes.forEach(type => {
                vehicleTypeFilter.innerHTML += `<option value="${type}">${type}</option>`;
            });

            // 車輛狀態
            const vehicleStatusFilter = document.getElementById('vehicleStatusFilter');
            vehicleStatusFilter.innerHTML = '<option value="">全部</option>';
            dropdownData.vehicleStatuses.forEach(status => {
                vehicleStatusFilter.innerHTML += `<option value="${status}">${status}</option>`;
            });
        }

        /**
         * 載入 KPI 資料
         */
        async function loadKPIData() {
            try {
                const response = await callGoogleAppsScript('getKPIData');
                if (response.success) {
                    renderKPIDashboard(response.data);
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('載入 KPI 資料失敗:', error);
                throw error;
            }
        }

               /**
         * 渲染 KPI 儀表板
         */
        function renderKPIDashboard(kpiData) {
            const dashboard = document.getElementById('kpiDashboard');
            
            const kpiCards = [
                {
                    icon: 'fas fa-tasks',
                    value: kpiData.totalTasks,
                    label: '總任務數',
                    change: '+5%',
                    changeType: 'positive'
                },
                {
                    icon: 'fas fa-exclamation-triangle',
                    value: kpiData.pTasks,
                    label: 'P級任務',
                    change: '+2',
                    changeType: 'negative'
                },
                {
                    icon: 'fas fa-clock',
                    value: kpiData.qTasks,
                    label: 'Q級任務',
                    change: '+3',
                    changeType: 'positive'
                },
                {
                    icon: 'fas fa-check-circle',
                    value: kpiData.rTasks,
                    label: 'R級任務',
                    change: '+8',
                    changeType: 'positive'
                },
                {
                    icon: 'fas fa-clipboard-check',
                    value: kpiData.assignedTasks,
                    label: '已指派任務',
                    change: `${kpiData.assignRate}%`,
                    changeType: kpiData.assignRate >= 80 ? 'positive' : 'negative'
                },
                {
                    icon: 'fas fa-users',
                    value: kpiData.availableDrivers,
                    label: '可用司機',
                    change: '穩定',
                    changeType: 'positive'
                },
                {
                    icon: 'fas fa-truck',
                    value: kpiData.availableVehicles,
                    label: '可用車輛',
                    change: '充足',
                    changeType: 'positive'
                },
                {
                    icon: 'fas fa-chart-line',
                    value: `${kpiData.efficiency}%`,
                    label: '調度效率',
                    change: kpiData.efficiency >= 85 ? '優秀' : '待改善',
                    changeType: kpiData.efficiency >= 85 ? 'positive' : 'negative'
                }
            ];

            dashboard.innerHTML = kpiCards.map(card => `
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="${card.icon}"></i>
                    </div>
                    <div class="kpi-value">${card.value}</div>
                    <div class="kpi-label">${card.label}</div>
                    <div class="kpi-change ${card.changeType}">${card.change}</div>
                </div>
            `).join('');
        }

        /**
         * 載入任務資料
         */
        async function loadTasks(filters = {}) {
            try {
                const response = await callGoogleAppsScript('getTasks', filters);
                if (response.success) {
                    currentTasks = response.data;
                    renderTasksTable(currentTasks);
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('載入任務資料失敗:', error);
                throw error;
            }
        }

        /**
         * 渲染任務表格
         */
        function renderTasksTable(tasks) {
            const tbody = document.getElementById('tasksTableBody');
            
            if (tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i><br>
                            暫無任務資料
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = tasks.map(task => `
                <tr onclick="selectTask('${task.id}')" style="cursor: pointer;" 
                    class="${selectedTaskId === task.id ? 'table-active' : ''}">
                    <td>${task['配送單號'] || task.id}</td>
                    <td>${task['客戶簡稱'] || ''}</td>
                    <td>
                        <span class="status-badge level-${(task.level || 'R').toLowerCase()}">
                            ${task.level || 'R'}級
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(task['配送狀態'])}">
                            ${task['配送狀態'] || '待派'}
                        </span>
                    </td>
                    <td>${formatDateTime(task['日期'])} ${task['配送時間'] || ''}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); generateSuggestions('${task.id}')">
                                <i class="fas fa-lightbulb"></i> 建議
                            </button>
                            ${task['配送狀態'] === '待派' ? `
                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); showAssignModal('${task.id}')">
                                    <i class="fas fa-user-plus"></i> 指派
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * 載入司機資料
         */
        async function loadDrivers(filters = {}) {
            try {
                const response = await callGoogleAppsScript('getDrivers', filters);
                if (response.success) {
                    currentDrivers = response.data;
                    renderDriversTable(currentDrivers);
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('載入司機資料失敗:', error);
                throw error;
            }
        }

        /**
         * 渲染司機表格
         */
        function renderDriversTable(drivers) {
            const tbody = document.getElementById('driversTableBody');
            
            if (drivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                            暫無司機資料
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = drivers.map(driver => `
                <tr>
                    <td>${driver['員工編號'] || driver.id}</td>
                    <td>${driver['姓名'] || ''}</td>
                    <td>
                        <span class="status-badge level-${(driver['等級'] || 'C').toLowerCase()}">
                            ${driver['等級'] || 'C'}級
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(driver['狀態'])}">
                            ${driver['狀態'] || '待命'}
                        </span>
                    </td>
                    <td>${driver['今日工時'] || 0} 小時</td>
                    <td>${Math.round((driver['準點率'] || 0) * 100)}%</td>
                    <td>
                        <div class="action-buttons">
                            ${selectedTaskId ? `
                                <button class="btn btn-sm btn-success" onclick="assignTaskToDriver('${selectedTaskId}', '${driver.id}')">
                                    <i class="fas fa-plus"></i> 指派
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="viewDriverDetails('${driver.id}')">
                                <i class="fas fa-eye"></i> 詳情
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * 載入車輛資料
         */
        async function loadVehicles(filters = {}) {
            try {
                const response = await callGoogleAppsScript('getVehicles', filters);
                if (response.success) {
                    currentVehicles = response.data;
                    renderVehiclesTable(currentVehicles);
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('載入車輛資料失敗:', error);
                throw error;
            }
        }

        /**
         * 渲染車輛表格
         */
        function renderVehiclesTable(vehicles) {
            const tbody = document.getElementById('vehiclesTableBody');
            
            if (vehicles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                            暫無車輛資料
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = vehicles.map(vehicle => `
                <tr>
                    <td>${vehicle['車牌號碼'] || vehicle.id}</td>
                    <td>${vehicle['車輛類型'] || ''}</td>
                    <td>${vehicle['容量'] || 0} 噸</td>
                    <td>
                        <span class="status-badge ${getStatusClass(vehicle['狀態'])}">
                            ${vehicle['狀態'] || '待命'}
                        </span>
                    </td>
                    <td>${vehicle['今日使用次數'] || 0} 次</td>
                    <td>
                        <div class="action-buttons">
                            ${selectedTaskId ? `
                                <button class="btn btn-sm btn-success" onclick="assignTaskToVehicle('${selectedTaskId}', '${vehicle.id}')">
                                    <i class="fas fa-plus"></i> 指派
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="viewVehicleDetails('${vehicle.id}')">
                                <i class="fas fa-eye"></i> 詳情
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * 選擇任務
         */
        function selectTask(taskId) {
            selectedTaskId = taskId;
            const task = currentTasks.find(t => t.id === taskId);
            
            if (task) {
                // 更新選中任務資訊
                document.getElementById('selectedTaskInfo').style.display = 'block';
                document.getElementById('selectedTaskId').textContent = task['配送單號'] || task.id;
                document.getElementById('selectedTaskCustomer').textContent = task['客戶簡稱'] || '';
                document.getElementById('selectedTaskLevel').textContent = task.level || 'R';
                document.getElementById('selectedTaskTime').textContent = formatDateTime(task['日期']) + ' ' + (task['配送時間'] || '');
                
                // 重新渲染表格以顯示選中狀態
                renderTasksTable(currentTasks);
                renderDriversTable(currentDrivers);
                renderVehiclesTable(currentVehicles);
                
                // 自動產生建議
                generateSuggestions(taskId);
            }
        }

        /**
         * 產生配對建議
         */
        async function generateSuggestions(taskId) {
            try {
                const suggestionsContainer = document.getElementById('suggestionsContainer');
                suggestionsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div class="loading"></div>
                        <p style="margin-top: 15px;">正在分析最佳配對建議...</p>
                    </div>
                `;

                const response = await callGoogleAppsScript('generateTop3', { taskId });
                
                if (response.success && response.data.length > 0) {
                    renderSuggestions(response.data);
                } else {
                    suggestionsContainer.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                            <p>暫無可用的配對建議</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">${response.error || '請檢查資源可用性'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('產生建議失敗:', error);
                document.getElementById('suggestionsContainer').innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 40px;">
                        <i class="fas fa-times-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>產生建議失敗</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        /**
         * 渲染配對建議
         */
        function renderSuggestions(suggestions) {
            const container = document.getElementById('suggestionsContainer');
            
            container.innerHTML = suggestions.map((suggestion, index) => `
                <div class="suggestion-card">
                    <div class="suggestion-header">
                        <h4>
                            <i class="fas fa-${suggestion.type === 'driver' ? 'user' : 'truck'}"></i>
                            建議 ${index + 1}: ${suggestion.name}
                        </h4>
                        <div class="suggestion-score">${Math.round(suggestion.score * 100)}分</div>
                    </div>
                    <div class="suggestion-details">
                        ${Object.values(suggestion.details).map(detail => `<div>• ${detail}</div>`).join('')}
                    </div>
                    <div class="suggestion-actions">
                        <button class="btn btn-sm btn-success" onclick="acceptSuggestion('${suggestion.id}', '${suggestion.type}')">
                            <i class="fas fa-check"></i> 接受建議
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="checkConflicts('${suggestion.id}', '${suggestion.type}')">
                            <i class="fas fa-exclamation-triangle"></i> 檢查衝突
                        </button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * 接受建議
         */
        async function acceptSuggestion(suggestionId, suggestionType) {
            try {
                if (!selectedTaskId) {
                    showNotification('請先選擇任務', 'warning');
                    return;
                }

                const response = await callGoogleAppsScript('acceptSuggestion', {
                    taskId: selectedTaskId,
                    suggestionId: suggestionId,
                    suggestionType: suggestionType
                });

                if (response.success) {
                    showNotification('建議已接受並完成指派', 'success');
                    await refreshData();
                } else {
                    showNotification('接受建議失敗: ' + response.error, 'error');
                }
            } catch (error) {
                console.error('接受建議失敗:', error);
                showNotification('接受建議失敗: ' + error.message, 'error');
            }
        }

        /**
         * 檢查衝突
         */
        async function checkConflicts(resourceId, resourceType) {
            try {
                const response = await callGoogleAppsScript('conflictCheck', {
                    taskId: selectedTaskId,
                    resourceId: resourceId,
                    resourceType: resourceType
                });

                if (response.success) {
                    if (response.data.hasConflicts) {
                        const conflictMessages = response.data.conflicts.map(c => c.message).join('\n');
                        alert('發現衝突:\n\n' + conflictMessages);
                    } else {
                        showNotification('無衝突，可以安全指派', 'success');
                    }
                } else {
                    showNotification('衝突檢查失敗: ' + response.error, 'error');
                }
            } catch (error) {
                console.error('衝突檢查失敗:', error);
                showNotification('衝突檢查失敗: ' + error.message, 'error');
            }
        }

        /**
         * 直接指派任務給司機
         */
        async function assignTaskToDriver(taskId, driverId) {
            try {
                const response = await callGoogleAppsScript('assignToDriver', {
                    taskId: taskId,
                    driverId: driverId
                });

                if (response.success) {
                    showNotification('已成功指派給司機', 'success');
                    await refreshData();
                } else {
                    showNotification('指派失敗: ' + response.error, 'error');
                }
            } catch (error) {
                console.error('指派失敗:', error);
                showNotification('指派失敗: ' + error.message, 'error');
            }
        }

        /**
         * 直接指派任務給車輛
         */
        async function assignTaskToVehicle(taskId, vehicleId) {
            try {
                const response = await callGoogleAppsScript('assignToVehicle', {
                    taskId: taskId,
                    vehicleId: vehicleId
                });

                if (response.success) {
                    showNotification('已成功指派給車輛', 'success');
                    await refreshData();
                } else {
                    showNotification('指派失敗: ' + response.error, 'error');
                }
            } catch (error) {
                console.error('指派失敗:', error);
                showNotification('指派失敗: ' + error.message, 'error');
            }
        }

        /**
         * 自動配對全部待派任務
         */
        async function autoAssignAll() {
            if (!confirm('確定要自動配對所有待派任務嗎？')) {
                return;
            }

            try {
                showLoadingOverlay(true);
                
                const response = await callGoogleAppsScript('autoAssign');
                
                if (response.success) {
                    const { totalTasks, successCount, results } = response.data;
                    showNotification(`自動配對完成：${successCount}/${totalTasks} 任務成功指派`, 'success');
                    
                    // 顯示詳細結果
                    const failedTasks = results.filter(r => !r.assigned);
                    if (failedTasks.length > 0) {
                        console.log('未成功指派的任務:', failedTasks);
                    }
                    
                    await refreshData();
                } else {
                    showNotification('自動配對失敗: ' + response.error, 'error');
                }
            } catch (error) {
                console.error('自動配對失敗:', error);
                showNotification('自動配對失敗: ' + error.message, 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        /**
         * 發佈到APP
         */
        async function publishToApp() {
            try {
                // 取得已指派但未通知的任務
                const assignedTasks = currentTasks.filter(task => 
                    task['配送狀態'] === '已派' && task['指派司機']
                );

                if (assignedTasks.length === 0) {
                    showNotification('沒有需要發佈的任務', 'warning');
                    return;
                }

                if (!confirm(`確定要發佈 ${assignedTasks.length} 個任務到APP嗎？`)) {
                    return;
                }

                showLoadingOverlay(true);

                const assignments = assignedTasks.map(task => ({
                    taskId: task.id,
                    driverId: task['指派司機'],
                    vehicleId: task['指派車輛'],
                    customerName: task['客戶簡稱'],
                    deliveryTime: task['配送時間']
                }));

                const response = await callGoogleAppsScript('publishToApp', { assignments });

                if (response.success) {
                    const { successCount, totalAssignments } = response.data;
                    showNotification(`發佈完成：${successCount}/${totalAssignments} 任務成功推播`, 'success');
                    await refreshData();
                } else {
                    showNotification('發佈失敗: ' + response.error, 'error');
                }
            } catch (error) {
                console.error('發佈失敗:', error);
                showNotification('發佈失敗: ' + error.message, 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        /**
         * 匯出結果
         */
        function exportResults() {
            try {
                // 準備匯出資料
                const exportData = {
                    tasks: currentTasks,
                    drivers: currentDrivers,
                    vehicles: currentVehicles,
                    exportTime: new Date().toISOString()
                };

                // 轉換為CSV格式
                const csvContent = convertToCSV(exportData.tasks);
                
                // 建立下載連結
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `調度結果_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('匯出完成', 'success');
            } catch (error) {
                console.error('匯出失敗:', error);
                showNotification('匯出失敗: ' + error.message, 'error');
            }
        }

        /**
         * 轉換為CSV格式
         */
        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => 
                headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(',')
            );

            return [csvHeaders, ...csvRows].join('\n');
        }

        /**
         * 篩選任務
         */
        function filterTasks() {
            const dateFilter = document.getElementById('taskDateFilter').value;
            const statusFilter = document.getElementById('taskStatusFilter').value;
            const levelFilter = document.getElementById('taskLevelFilter').value;
            const customerFilter = document.getElementById('taskCustomerFilter').value;

            const filters = {};
            if (dateFilter) filters.date = dateFilter;
            if (statusFilter) filters.status = statusFilter;
            if (levelFilter) filters.level = levelFilter;
            if (customerFilter) filters.customer = customerFilter;

            loadTasks(filters);
        }

        /**
         * 篩選司機
         */
        function filterDrivers() {
            const levelFilter = document.getElementById('driverLevelFilter').value;
            const statusFilter = document.getElementById('driverStatusFilter').value;

            const filters = {};
            if (levelFilter) filters.level = levelFilter;
            if (statusFilter) filters.status = statusFilter;

            loadDrivers(filters);
        }

        /**
         * 篩選車輛
         */
        function filterVehicles() {
            const typeFilter = document.getElementById('vehicleTypeFilter').value;
            const statusFilter = document.getElementById('vehicleStatusFilter').value;

            const filters = {};
            if (typeFilter) filters.type = typeFilter;
            if (statusFilter) filters.status = statusFilter;

            loadVehicles(filters);
        }

        /**
         * 重新整理所有資料
         */
        async function refreshData() {
            try {
                showLoadingOverlay(true);
                await Promise.all([
                    loadKPIData(),
                    loadTasks(),
                    loadDrivers(),
                    loadVehicles()
                ]);
                updateLastUpdatedTime();
                showNotification('資料已更新', 'success');
            } catch (error) {
                console.error('重新整理失敗:', error);
                showNotification('重新整理失敗: ' + error.message, 'error');
            } finally {
                showLoadingOverlay(false);
            }
        }

        /**
         * 呼叫 Google Apps Script
         */
        async function callGoogleAppsScript(action, data = {}) {
            const formData = new FormData();
            formData.append('action', action);
            formData.append('data', encodeURIComponent(JSON.stringify(data)));

            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log(`${action} 回應:`, result);
            
            return result;
        }

        /**
         * 工具函數
         */
        function getStatusClass(status) {
            const statusMap = {
                '待派': 'status-pending',
                '已派': 'status-assigned',
                '進行中': 'status-in-progress',
                '已完成': 'status-completed',
                '可派遣': 'status-assigned',
                '待命': 'status-pending',
                '休息': 'status-completed',
                '可用': 'status-assigned',
                '使用中': 'status-in-progress',
                '維修': 'status-pending'
            };
            return statusMap[status] || 'status-pending';
        }

        function formatDateTime(dateValue) {
            if (!dateValue) return '';
            const date = new Date(dateValue);
            if (isNaN(date.getTime())) return dateValue;
            return date.toLocaleDateString('zh-TW');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showLoadingOverlay(show) {
            let overlay = document.getElementById('loadingOverlay');
            
            if (show) {
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'loadingOverlay';
                    overlay.className = 'loading-overlay';
                    overlay.innerHTML = '<div class="loading-spinner"></div>';
                    document.body.appendChild(overlay);
                }
                overlay.style.display = 'flex';
            } else {
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            document.getElementById('lastUpdated').textContent = `最後更新：${timeString}`;
        }

        // 查看詳情功能（可擴展）
        function viewDriverDetails(driverId) {
            const driver = currentDrivers.find(d => d.id === driverId);
            if (driver) {
                alert(`司機詳情:\n姓名: ${driver['姓名']}\n等級: ${driver['等級']}\n狀態: ${driver['狀態']}\n今日工時: ${driver['今日工時']}小時\n準點率: ${Math.round((driver['準點率'] || 0) * 100)}%`);
            }
        }

        function viewVehicleDetails(vehicleId) {
            const vehicle = currentVehicles.find(v => v.id === vehicleId);
            if (vehicle) {
                alert(`車輛詳情:\n車牌: ${vehicle['車牌號碼']}\n類型: ${vehicle['車輛類型']}\n容量: ${vehicle['容量']}噸\n狀態: ${vehicle['狀態']}\n今日使用: ${vehicle['今日使用次數']}次`);
            }
        }

        // CSS 樣式補充
        const additionalStyles = `
            .table-active {
                background-color: #e3f2fd !important;
            }
            
            .table-active:hover {
                background-color: #bbdefb !important;
            }
        `;

        // 動態添加樣式
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
