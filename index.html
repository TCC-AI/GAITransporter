<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAI優化運務人員調派建議系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-tab {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab:hover, .nav-tab.active {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Styles */
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .kpi-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .alert-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .alert-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .alert-icon {
            margin-right: 10px;
            color: #e74c3c;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(238, 90, 82, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(238, 90, 82, 0.4);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            box-shadow: 0 4px 15px rgba(68, 160, 141, 0.3);
        }

        .action-btn.secondary:hover {
            box-shadow: 0 8px 25px rgba(68, 160, 141, 0.4);
        }

        /* Schedule Board Styles */
        .schedule-board {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .filter-select {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .view-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-btn {
            padding: 10px 20px;
            background: #ecf0f1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: #3498db;
            color: white;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            min-height: 500px;
        }

        .kanban-column {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .column-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
            text-align: center;
        }

        .task-card {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: grab;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }

        .task-card:active {
            cursor: grabbing;
        }

        .task-id {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .task-customer {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .task-priority {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .priority-p {
            background: #e74c3c;
            color: white;
        }

        .priority-q {
            background: #f39c12;
            color: white;
        }

        .priority-r {
            background: #27ae60;
            color: white;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-assigned {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-progress {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .kanban-board {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚛 GAI優化運務人員調派建議系統</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">主控台</button>
                <button class="nav-tab" onclick="showTab('schedule')">當日調度盤</button>
                <button class="nav-tab" onclick="showTab('tasks')">任務管理</button>
                <button class="nav-tab" onclick="showTab('drivers')">司機管理</button>
                <button class="nav-tab" onclick="showTab('vehicles')">車輛管理</button>
                <button class="nav-tab" onclick="showTab('settings')">系統設定</button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value" id="totalTasks">0</div>
                        <div class="kpi-label">今日任務總數</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="assignedRate">0%</div>
                        <div class="kpi-label">已指派率</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="onlineVehicles">0</div>
                        <div class="kpi-label">已上線車數</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="priorityP">0</div>
                        <div class="kpi-label">P級任務</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="priorityQ">0</div>
                        <div class="kpi-label">Q級任務</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="priorityR">0</div>
                        <div class="kpi-label">R級任務</div>
                    </div>
                </div>

                <div class="alert-panel">
                    <h3>⚠️ 告警區</h3>
                    <div id="alertList">
                        <div class="alert-item">
                            <span class="alert-icon">🚨</span>
                            <span>尚無告警訊息</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="action-btn" onclick="autoAssign('top1')">
                    🎯 一鍵產生建議派遣
                </button>
                <button class="action-btn secondary" onclick="autoAssign('top3')">
                    📋 產生 Top-3 建議
                </button>
                <button class="action-btn" onclick="checkConflicts()">
                    ⚡ 衝突檢查
                </button>
                <button class="action-btn secondary" onclick="publishToApp()">
                    📱 全部發佈到司機APP
                </button>
            </div>
        </div>

        <!-- Schedule Board Tab -->
        <div id="schedule" class="tab-content">
            <div class="schedule-board">
                <h3>📅 當日調度盤</h3>
                
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">日期</label>
                        <input type="date" class="filter-select" id="filterDate">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">客戶等級</label>
                        <select class="filter-select" id="filterPriority">
                            <option value="">全部</option>
                            <option value="P">P級</option>
                            <option value="Q">Q級</option>
                            <option value="R">R級</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">車類</label>
                        <select class="filter-select" id="filterVehicle">
                            <option value="">全部</option>
                            <option value="甲">甲類</option>
                            <option value="乙">乙類</option>
                            <option value="丙">丙類</option>
                            <option value="丁">丁類</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">狀態</label>
                        <select class="filter-select" id="filterStatus">
                            <option value="">全部</option>
                            <option value="待派">待派</option>
                            <option value="已派">已派</option>
                            <option value="進行">進行中</option>
                            <option value="完成">完成</option>
                        </select>
                    </div>
                </div>

                <div class="view-switcher">
                    <button class="view-btn active" onclick="switchView('kanban')">看板</button>
                    <button class="view-btn" onclick="switchView('gantt')">甘特圖</button>
                    <button class="view-btn" onclick="switchView('map')">地圖</button>
                </div>

                <div id="kanbanView" class="kanban-board">
                    <div class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <h4 class="column-header">📋 任務池</h4>
                        <div id="taskPool"></div>
                    </div>
                    <div class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <h4 class="column-header">🚛 車輛</h4>
                        <div id="vehiclePool"></div>
                    </div>
                    <div class="kanban-column" ondrop="drop(event)" ondragover="allowDrop(event)">
                        <h4 class="column-header">👨‍💼 司機</h4>
                        <div id="driverPool"></div>
                    </div>
                </div>

                <div id="ganttView" style="display: none;">
                    <p>甘特圖視圖開發中...</p>
                </div>

                <div id="mapView" style="display: none;">
                    <p>地圖視圖開發中...</p>
                </div>
            </div>
        </div>

        <!-- Tasks Management Tab -->
        <div id="tasks" class="tab-content">
            <div class="schedule-board">
                <h3>📦 任務管理</h3>
                
                <div class="quick-actions" style="margin-bottom: 20px;">
                    <button class="action-btn" onclick="importFromSheet()">
                        📥 從 Google Sheet 匯入
                    </button>
                    <button class="action-btn secondary" onclick="showTaskForm()">
                        ➕ 新增任務
                    </button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>配送單號</th>
                            <th>客戶簡稱</th>
                            <th>配送日期</th>
                            <th>客戶等級</th>
                            <th>配送狀態</th>
                            <th>指派車輛</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tasksTableBody">
                        <!-- 任務資料將在此顯示 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Drivers Management Tab -->
        <div id="drivers" class="tab-content">
            <div class="schedule-board">
                <h3>👨‍💼 司機管理</h3>
                
                <div class="quick-actions" style="margin-bottom: 20px;">
                    <button class="action-btn" onclick="showDriverForm()">
                        ➕ 新增司機
                    </button>
                    <button class="action-btn secondary" onclick="checkDriverCertificates()">
                        📋 檢查證照到期
                    </button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>姓名</th>
                            <th>員工編號</th>
                            <th>等級</th>
                            <th>所屬</th>
                            <th>狀態</th>
                            <th>準點率</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="driversTableBody">
                        <!-- 司機資料將在此顯示 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vehicles Management Tab -->
        <div id="vehicles" class="tab-content">
            <div class="schedule-board">
                <h3>🚛 車輛管理</h3>
                
                <div class="quick-actions" style="margin-bottom: 20px;">
                    <button class="action-btn" onclick="showVehicleForm()">
                        ➕ 新增車輛
                    </button>
                    <button class="action-btn secondary" onclick="checkVehicleInspection()">
                        🔧 檢查年檢保險
                    </button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>車號</th>
                            <th>車類</th>
                            <th>溫層能力</th>
                            <th>載重(噸)</th>
                            <th>板位</th>
                            <th>狀態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTableBody">
                        <!-- 車輛資料將在此顯示 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="schedule-board">
                <h3>⚙️ 系統設定</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Google Sheet ID</label>
                        <input type="text" class="form-input" id="sheetId" value="1imMGGvAaNjlYpQ1CS63DWSewFQrmaTt3hNQAdrRUBjs">
                    </div>
                    <div class="form-group">
                        <label class="form-label">工作表名稱</label>
                        <input type="text" class="form-input" id="sheetName" value="配送任務">
                    </div>
                </div>

                <h4>配對規則設定</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">準點權重 (%)</label>
                        <input type="range" min="0" max="100" value="40" id="punctualityWeight" oninput="updateWeightDisplay()">
                        <span id="punctualityDisplay">40%</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">成本權重 (%)</label>
                        <input type="range" min="0" max="100" value="25" id="costWeight" oninput="updateWeightDisplay()">
                        <span id="costDisplay">25%</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">加班權重 (%)</label>
                        <input type="range" min="0" max="100" value="15" id="overtimeWeight" oninput="updateWeightDisplay()">
                        <span id="overtimeDisplay">15%</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">公平性權重 (%)</label>
                        <input type="range" min="0" max="100" value="20" id="fairnessWeight" oninput="updateWeightDisplay()">
                        <span id="fairnessDisplay">20%</span>
                    </div>
                </div>

                <button class="action-btn" onclick="saveSettings()">💾 儲存設定</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
            <h3>任務詳情</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">配送單號</label>
                    <input type="text" class="form-input" id="taskId">
                </div>
                <div class="form-group">
                    <label class="form-label">客戶簡稱</label>
                    <input type="text" class="form-input" id="customerName">
                </div>
                <div class="form-group">
                    <label class="form-label">配送日期</label>
                    <input type="date" class="form-input" id="deliveryDate">
                </div>
                <div class="form-group">
                    <label class="form-label">客戶等級</label>
                    <select class="form-input" id="customerLevel">
                        <option value="P">P級</option>
                        <option value="Q">Q級</option>
                        <option value="R">R級</option>
                    </select>
                </div>
            </div>
            <button class="action-btn" onclick="saveTask()">💾 儲存</button>
        </div>
    </div>

    <div id="driverModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('driverModal')">&times;</button>
            <h3>司機資料</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" class="form-input" id="driverName">
                </div>
                <div class="form-group">
                    <label class="form-label">員工編號</label>
                    <input type="text" class="form-input" id="driverCode">
                </div>
                <div class="form-group">
                    <label class="form-label">司機等級</label>
                    <select class="form-input" id="driverLevel">
                        <option value="A">A級</option>
                        <option value="B">B級</option>
                        <option value="C">C級</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">所屬</label>
                    <select class="form-input" id="driverType">
                        <option value="自有">自有</option>
                        <option value="加盟">加盟</option>
                    </select>
                </div>
            </div>
            <button class="action-btn" onclick="saveDriver()">💾 儲存</button>
        </div>
    </div>

    <div id="vehicleModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('vehicleModal')">&times;</button>
            <h3>車輛資料</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">車號</label>
                    <input type="text" class="form-input" id="vehicleNumber">
                </div>
                <div class="form-group">
                    <label class="form-label">車類</label>
                    <select class="form-input" id="vehicleType">
                        <option value="甲">甲類</option>
                        <option value="乙">乙類</option>
                        <option value="丙">丙類</option>
                        <option value="丁">丁類</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">載重(噸)</label>
                    <input type="number" class="form-input" id="vehicleCapacity">
                </div>
                <div class="form-group">
                    <label class="form-label">板位</label>
                    <input type="number" class="form-input" id="vehiclePallets">
                </div>
            </div>
            <button class="action-btn" onclick="saveVehicle()">💾 儲存</button>
        </div>
    </div>

    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <div class="loading">
                <div class="spinner"></div>
                <p>正在處理中...</p>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script URL (請替換為您的實際部署URL)
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzqcMcgLXeNzeqNQMvKNWoOHhzF_PLIrnMTJl7khtIDijdC0VB9eU9jJaJgaiPAn4Yu3Q/exec';
        
        // 全域變數
        let currentData = {
            tasks: [],
            drivers: [],
            vehicles: [],
            assignments: []
        };

        // 初始化系統
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            setTodayDate();
        });

        function initializeSystem() {
            loadDashboardData();
            loadTasksData();
            loadDriversData();
            loadVehiclesData();
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterDate').value = today;
        }

        // 標籤切換
        function showTab(tabName) {
            // 隱藏所有標籤內容
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 移除所有按鈕的 active 狀態
            const buttons = document.querySelectorAll('.nav-tab');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // 顯示選中的標籤
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // 載入儀表板資料
        async function loadDashboardData() {
            try {
                showLoading();
                
                const response = await callGAS('getDashboardData');
                
                if (response && response.success) {
                    updateKPIs(response.data);
                    updateAlerts(response.alerts);
                } else {
                    console.error('載入儀表板資料失敗:', response?.error);
                    showMessage('載入儀表板資料失敗', 'error');
                }
                
                hideLoading();
            } catch (error) {
                console.error('載入儀表板資料失敗:', error);
                showMessage('載入儀表板資料失敗: ' + error.message, 'error');
                hideLoading();
            }
        }

        function updateKPIs(data) {
            document.getElementById('totalTasks').textContent = data.totalTasks || 0;
            document.getElementById('assignedRate').textContent = (data.assignedRate || 0) + '%';
            document.getElementById('onlineVehicles').textContent = data.onlineVehicles || 0;
            document.getElementById('priorityP').textContent = data.priorityP || 0;
            document.getElementById('priorityQ').textContent = data.priorityQ || 0;
            document.getElementById('priorityR').textContent = data.priorityR || 0;
        }

        function updateAlerts(alerts) {
            const alertList = document.getElementById('alertList');
            if (alerts && alerts.length > 0) {
                alertList.innerHTML = alerts.map(alert => `
                    <div class="alert-item">
                        <span class="alert-icon">🚨</span>
                        <span>${alert}</span>
                    </div>
                `).join('');
            }
        }

        // 載入任務資料
        async function loadTasksData() {
            try {
                const response = await callGAS('getTasks');
                
                if (response && response.success) {
                    currentData.tasks = response.data;
                    updateTasksTable();
                    updateKanbanBoard();
                } else {
                    console.error('載入任務資料失敗:', response?.error);
                    showMessage('載入任務資料失敗', 'error');
                }
            } catch (error) {
                console.error('載入任務資料失敗:', error);
                showMessage('載入任務資料失敗: ' + error.message, 'error');
            }
        }

        function generateSampleTasks() {
            return [
                {
                    id: 'T001',
                    customerName: '全聯福利中心',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    priority: 'P',
                    status: '待派',
                    vehicle: '',
                    driver: ''
                },
                {
                    id: 'T002',
                    customerName: '家樂福',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    priority: 'Q',
                    status: '已派',
                    vehicle: '甲001',
                    driver: '張三'
                },
                {
                    id: 'T003',
                    customerName: '好市多',
                    deliveryDate: new Date().toISOString().split('T')[0],
                    priority: 'R',
                    status: '進行中',
                    vehicle: '乙002',
                    driver: '李四'
                }
            ];
        }

        function updateTasksTable() {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = currentData.tasks.map(task => `
                <tr>
                    <td>${task.id}</td>
                    <td>${task.customerName}</td>
                    <td>${task.deliveryDate}</td>
                    <td><span class="task-priority priority-${task.priority.toLowerCase()}">${task.priority}</span></td>
                    <td><span class="status-badge status-${getStatusClass(task.status)}">${task.status}</span></td>
                    <td>${task.vehicle || '-'}</td>
                    <td>
                        <button class="action-btn" style="padding: 5px 10px; font-size: 12px;" onclick="editTask('${task.id}')">編輯</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateKanbanBoard() {
            const taskPool = document.getElementById('taskPool');
            const vehiclePool = document.getElementById('vehiclePool');
            const driverPool = document.getElementById('driverPool');

            // 更新任務池
            taskPool.innerHTML = currentData.tasks.filter(task => task.status === '待派').map(task => `
                <div class="task-card" draggable="true" ondragstart="drag(event)" data-id="${task.id}">
                    <div class="task-id">${task.id}</div>
                    <div class="task-customer">${task.customerName}</div>
                    <span class="task-priority priority-${task.priority.toLowerCase()}">${task.priority}</span>
                </div>
            `).join('');

            // 更新車輛池
            vehiclePool.innerHTML = currentData.vehicles.map(vehicle => `
                <div class="task-card" draggable="true" ondragstart="drag(event)" data-id="${vehicle.number}">
                    <div class="task-id">${vehicle.number}</div>
                    <div class="task-customer">${vehicle.type}類車</div>
                </div>
            `).join('');

            // 更新司機池
            driverPool.innerHTML = currentData.drivers.map(driver => `
                <div class="task-card" draggable="true" ondragstart="drag(event)" data-id="${driver.code}">
                    <div class="task-id">${driver.name}</div>
                    <div class="task-customer">${driver.level}級司機</div>
                </div>
            `).join('');
        }

        // 載入司機資料
        async function loadDriversData() {
            try {
                const response = await callGAS('getDrivers');
                
                if (response && response.success) {
                    currentData.drivers = response.data;
                } else {
                    console.error('載入司機資料失敗:', response?.error);
                    showMessage('載入司機資料失敗', 'error');
                }
                updateDriversTable();
            } catch (error) {
                console.error('載入司機資料失敗:', error);
                showMessage('載入司機資料失敗: ' + error.message, 'error');
                updateDriversTable();
            }
        }

        function generateSampleDrivers() {
            return [
                {
                    name: '張三',
                    code: 'D001',
                    level: 'A',
                    type: '自有',
                    status: '可派',
                    punctuality: 95
                },
                {
                    name: '李四',
                    code: 'D002',
                    level: 'B',
                    type: '加盟',
                    status: '出勤中',
                    punctuality: 88
                },
                {
                    name: '王五',
                    code: 'D003',
                    level: 'C',
                    type: '自有',
                    status: '可派',
                    punctuality: 92
                }
            ];
        }

        function updateDriversTable() {
            const tbody = document.getElementById('driversTableBody');
            tbody.innerHTML = currentData.drivers.map(driver => `
                <tr>
                    <td>${driver.name}</td>
                    <td>${driver.code}</td>
                    <td>${driver.level}</td>
                    <td>${driver.type}</td>
                    <td><span class="status-badge status-${getStatusClass(driver.status)}">${driver.status}</span></td>
                    <td>${driver.punctuality}%</td>
                    <td>
                        <button class="action-btn" style="padding: 5px 10px; font-size: 12px;" onclick="editDriver('${driver.code}')">編輯</button>
                    </td>
                </tr>
            `).join('');
        }

        // 載入車輛資料
        async function loadVehiclesData() {
            try {
                const response = await callGAS('getVehicles');
                
                if (response && response.success) {
                    currentData.vehicles = response.data;
                } else {
                    console.error('載入車輛資料失敗:', response?.error);
                    showMessage('載入車輛資料失敗', 'error');
                }
                updateVehiclesTable();
            } catch (error) {
                console.error('載入車輛資料失敗:', error);
                showMessage('載入車輛資料失敗: ' + error.message, 'error');
                updateVehiclesTable();
            }
        }

        function generateSampleVehicles() {
            return [
                {
                    number: '甲001',
                    type: '甲',
                    temperature: '冷凍/冷藏',
                    capacity: 15,
                    pallets: 20,
                    status: '可用'
                },
                {
                    number: '乙002',
                    type: '乙',
                    temperature: '冷藏',
                    capacity: 10,
                    pallets: 15,
                    status: '調度中'
                },
                {
                    number: '丙003',
                    type: '丙',
                    temperature: '常溫',
                    capacity: 8,
                    pallets: 12,
                    status: '可用'
                }
            ];
        }

        function updateVehiclesTable() {
            const tbody = document.getElementById('vehiclesTableBody');
            tbody.innerHTML = currentData.vehicles.map(vehicle => `
                <tr>
                    <td>${vehicle.number}</td>
                    <td>${vehicle.type}</td>
                    <td>${vehicle.temperature}</td>
                    <td>${vehicle.capacity}</td>
                    <td>${vehicle.pallets}</td>
                    <td><span class="status-badge status-${getStatusClass(vehicle.status)}">${vehicle.status}</span></td>
                    <td>
                        <button class="action-btn" style="padding: 5px 10px; font-size: 12px;" onclick="editVehicle('${vehicle.number}')">編輯</button>
                    </td>
                </tr>
            `).join('');
        }

        // 工具函數
        function getStatusClass(status) {
            const statusMap = {
                '待派': 'pending',
                '已派': 'assigned',
                '進行中': 'progress',
                '出勤中': 'progress',
                '完成': 'completed',
                '可派': 'assigned',
                '可用': 'assigned',
                '調度中': 'progress',
                '保養': 'completed'
            };
            return statusMap[status] || 'pending';
        }

        // Google Apps Script 呼叫 - 使用 JSONP 完全避免 CORS
        async function callGAS(action, data = {}) {
            return new Promise((resolve, reject) => {
                // 建立唯一的回調函數名稱
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // 設定全域回調函數
                window[callbackName] = function(response) {
                    // 清理
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    resolve(response);
                };
                
                // 準備參數
                const params = new URLSearchParams({
                    action: action,
                    data: JSON.stringify(data),
                    callback: callbackName
                });
                
                // 建立 script 標籤
                const script = document.createElement('script');
                script.src = `${GAS_URL}?${params.toString()}`;
                
                // 錯誤處理
                script.onerror = function() {
                    delete window[callbackName];
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    reject(new Error('載入腳本失敗'));
                };
                
                // 超時處理
                const timeout = setTimeout(() => {
                    if (window[callbackName]) {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('請求超時'));
                    }
                }, 15000); // 15秒超時
                
                // 成功時清除超時
                const originalCallback = window[callbackName];
                window[callbackName] = function(response) {
                    clearTimeout(timeout);
                    originalCallback(response);
                };
                
                // 添加到頁面
                document.head.appendChild(script);
            });
        }

        // 自動配對功能
        async function autoAssign(type) {
            showLoading();
            
            try {
                const response = await callGAS('autoAssign', { type: type });
                
                if (response.success) {
                    showMessage('自動配對完成！', 'success');
                    loadTasksData();
                    loadDashboardData();
                } else {
                    showMessage('自動配對失敗：' + (response.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('自動配對失敗:', error);
                showMessage('自動配對失敗：網路錯誤', 'error');
            }
            
            hideLoading();
        }

        // 衝突檢查
        async function checkConflicts() {
            showLoading();
            
            try {
                const response = await callGAS('checkConflicts');
                
                if (response.success) {
                    if (response.conflicts && response.conflicts.length > 0) {
                        showMessage(`發現 ${response.conflicts.length} 個衝突`, 'error');
                        updateAlerts(response.conflicts);
                    } else {
                        showMessage('未發現衝突', 'success');
                    }
                } else {
                    showMessage('衝突檢查失敗', 'error');
                }
            } catch (error) {
                console.error('衝突檢查失敗:', error);
                showMessage('衝突檢查失敗：網路錯誤', 'error');
            }
            
            hideLoading();
        }

        // 發佈到APP
        async function publishToApp() {
            showLoading();
            
            try {
                const response = await callGAS('publishToApp');
                
                if (response.success) {
                    showMessage('成功發佈到司機APP', 'success');
                } else {
                    showMessage('發佈失敗：' + (response.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('發佈失敗:', error);
                showMessage('發佈失敗：網路錯誤', 'error');
            }
            
            hideLoading();
        }

        // 從 Google Sheet 匯入
        async function importFromSheet() {
            showLoading();
            
            try {
                const sheetId = document.getElementById('sheetId').value;
                const sheetName = document.getElementById('sheetName').value;
                
                const response = await callGAS('importFromSheet', {
                    sheetId: sheetId,
                    sheetName: sheetName
                });
                
                if (response.success) {
                    showMessage('匯入成功！', 'success');
                    loadTasksData();
                    loadDashboardData();
                } else {
                    showMessage('匯入失敗：' + (response.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('匯入失敗:', error);
                showMessage('匯入失敗：網路錯誤', 'error');
            }
            
            hideLoading();
        }

        // 顯示表單
        function showTaskForm() {
            document.getElementById('taskModal').style.display = 'block';
        }

        function showDriverForm() {
            document.getElementById('driverModal').style.display = 'block';
        }

        function showVehicleForm() {
            document.getElementById('vehicleModal').style.display = 'block';
        }

        // 關閉模態框
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 儲存資料
        async function saveTask() {
            const taskData = {
                id: document.getElementById('taskId').value,
                customerName: document.getElementById('customerName').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                priority: document.getElementById('customerLevel').value
            };
            
            try {
                const response = await callGAS('saveTask', taskData);
                
                if (response.success) {
                    showMessage('任務儲存成功！', 'success');
                    closeModal('taskModal');
                    loadTasksData();
                } else {
                    showMessage('儲存失敗：' + (response.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('儲存失敗:', error);
                showMessage('儲存失敗：網路錯誤', 'error');
            }
        }

        async function saveDriver() {
            const driverData = {
                name: document.getElementById('driverName').value,
                code: document.getElementById('driverCode').value,
                level: document.getElementById('driverLevel').value,
                type: document.getElementById('driverType').value
            };
            
            try {
                const response = await callGAS('saveDriver', driverData);
                
                if (response.success) {
                    showMessage('司機資料儲存成功！', 'success');
                    closeModal('driverModal');
                    loadDriversData();
                } else {
                    showMessage('儲存失敗：' + (response.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('儲存失敗:', error);
                showMessage('儲存失敗：網路錯誤', 'error');
            }
        }

        async function saveVehicle() {
            const vehicleData = {
                number: document.getElementById('vehicleNumber').value,
                type: document.getElementById('vehicleType').value,
                capacity: document.getElementById('vehicleCapacity').value,
                pallets: document.getElementById('vehiclePallets').value
            };
            
            try {
                const response = await callGAS('saveVehicle', vehicleData);
                
                if (response.success) {
                    showMessage('車輛資料儲存成功！', 'success');
                    closeModal('vehicleModal');
                    loadVehiclesData();
                } else {
                    showMessage('儲存失敗：' + (response.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('儲存失敗:', error);
                showMessage('儲存失敗：網路錯誤', 'error');
            }
        }

        // 拖拽功能
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.getAttribute('data-id'));
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            // 這裡可以實現拖拽配對邏輯
            console.log('Dropped:', data);
        }

        // 視圖切換
        function switchView(viewType) {
            const views = ['kanban', 'gantt', 'map'];
            views.forEach(view => {
                document.getElementById(view + 'View').style.display = 'none';
            });
            
            document.getElementById(viewType + 'View').style.display = 'block';
            
            const buttons = document.querySelectorAll('.view-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 權重顯示更新
        function updateWeightDisplay() {
            document.getElementById('punctualityDisplay').textContent = 
                document.getElementById('punctualityWeight').value + '%';
            document.getElementById('costDisplay').textContent = 
                document.getElementById('costWeight').value + '%';
            document.getElementById('overtimeDisplay').textContent = 
                document.getElementById('overtimeWeight').value + '%';
            document.getElementById('fairnessDisplay').textContent = 
                document.getElementById('fairnessWeight').value + '%';
        }

        // 儲存設定
        async function saveSettings() {
            const settings = {
                sheetId: document.getElementById('sheetId').value,
                sheetName: document.getElementById('sheetName').value,
                weights: {
                    punctuality: document.getElementById('punctualityWeight').value,
                    cost: document.getElementById('costWeight').value,
                    overtime: document.getElementById('overtimeWeight').value,
                    fairness: document.getElementById('fairnessWeight').value
                }
            };
            
            try {
                const response = await callGAS('saveSettings', settings);
                
                if (response.success) {
                    showMessage('設定儲存成功！', 'success');
                } else {
                    showMessage('設定儲存失敗：' + (response.error || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('設定儲存失敗:', error);
                showMessage('設定儲存失敗：網路錯誤', 'error');
            }
        }

        // 載入中顯示
        function showLoading() {
            document.getElementById('loadingModal').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingModal').style.display = 'none';
        }

        // 訊息顯示
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-msg' : 'error-msg';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '10000';
            messageDiv.style.minWidth = '300px';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                document.body.removeChild(messageDiv);
            }, 3000);
        }

        // 編輯功能（placeholder）
        function editTask(taskId) {
            console.log('編輯任務:', taskId);
        }

        function editDriver(driverCode) {
            console.log('編輯司機:', driverCode);
        }

        function editVehicle(vehicleNumber) {
            console.log('編輯車輛:', vehicleNumber);
        }

        function checkDriverCertificates() {
            showMessage('檢查證照功能開發中...', 'info');
        }

        function checkVehicleInspection() {
            showMessage('檢查年檢功能開發中...', 'info');
        }
    </script>
</body>
</html>
